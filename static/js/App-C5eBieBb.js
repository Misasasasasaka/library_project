import{g as a,E as de,c as te,h as Le,x as Re,i as re,j as V,d as g,b as t,e as v,w as i,r as ze,k as d,v as p,l as Ie,u as ce,M as ve,o as y,f as L,t as n,n as Ne,G as pe,y as le,F as Ee,m as Ae,B as qe,N as se,C as k,A as me,O as Ke,P as fe}from"./index-DwFnw12e.js";import{_ as be,M as R}from"./Modal-C3O8S5He.js";import{S as Ge,_ as Te}from"./Pagination-B8qsCkL_.js";const We={class:"flex items-center justify-between mb-8"},Ze={class:"flex gap-3"},He={class:"flex items-center gap-4 mb-6"},Je={class:"flex-1 relative"},Qe={class:"font-mono text-xs bg-sidebar px-2 py-1 rounded"},Xe={class:"text-text-secondary"},Ye={class:"text-text-muted"},et={class:"flex gap-3"},tt=["onClick"],lt=["onClick"],st=["onClick"],at={class:"mt-8"},ot={class:"grid grid-cols-2 gap-5"},nt=["value"],it={class:"col-span-2"},ut={class:"flex items-center gap-4"},dt={class:"w-20 h-28 bg-sidebar rounded-xl overflow-hidden border border-border flex-shrink-0"},rt=["src"],ct={key:1,class:"w-full h-full flex items-center justify-center text-text-light"},vt={class:"flex-1 min-w-0"},pt={class:"mt-2 flex items-center justify-between gap-4"},mt={class:"col-span-2"},ft={key:0,class:"mt-4 p-3 bg-red-50 text-red-600 text-sm rounded-xl"},bt={class:"mt-6 flex justify-end gap-3"},gt=["disabled"],yt={class:"text-text-secondary"},xt=["disabled"],_t={class:"flex items-center justify-between mb-4"},ht={class:"text-text-muted"},kt={class:"flex gap-3"},wt=["onClick"],Ct=["onClick"],Vt={class:"space-y-5"},Ut={key:0,class:"mt-4 p-3 bg-red-50 text-red-600 text-sm rounded-xl"},Mt={class:"mt-6 flex justify-end gap-3"},St=["disabled"],jt={class:"text-text-secondary"},Bt=["disabled"],ae=20,Ot={__name:"App",setup($t){const ge=[{key:"isbn",title:"ISBN",width:"130px"},{key:"title",title:"书名"},{key:"author",title:"作者",width:"120px"},{key:"copies",title:"库存",width:"100px"},{key:"status",title:"状态",width:"90px"},{key:"actions",title:"操作",width:"160px"}],ye=[{key:"name",title:"分类名称",width:"180px"},{key:"description",title:"简介"},{key:"actions",title:"操作",width:"140px"}],H=a([]),U=a([]),M=a(!1),J=a(!0),Q=a(!1),z=a(""),I=a(""),m=a(1),oe=a(0),S=a(!1),j=a(!1),N=a(!1),E=a(!1),B=a(!1),c=a(null),A=a(null),$=a(null),F=a(null),q=a(!1),K=a(!1),G=a(!1),T=a(!1),x=a(""),_=a(""),X=a(null),P=a(null),W=a("");let h=null;const o=de({isbn:"",title:"",author:"",publisher:"",publish_date:"",category_id:null,total_copies:1,location:"",description:""}),f=de({name:"",description:""}),Z=te(()=>Math.max(1,Math.ceil(oe.value/ae))),xe=te(()=>{if(M.value)return H.value;const s=(m.value-1)*ae;return H.value.slice(s,s+ae)}),_e=te(()=>U.value);Le(async()=>{await Promise.all([b(),w()])}),Re([M,Z],()=>{M.value||(m.value>Z.value&&(m.value=Z.value),m.value<1&&(m.value=1))});async function w(){Q.value=!0;try{const s=await re("/api/categories");U.value=s.results||s.categories||[]}catch(s){V(s.message||"加载分类失败")}finally{Q.value=!1}}async function b({keepPage:s=!1}={}){s||(m.value=1),J.value=!0;try{const e=new URLSearchParams;z.value&&e.set("kw",z.value),I.value&&e.set("status",I.value),e.set("page",m.value);const r=await re("/api/books?"+e.toString()),l=r.results||r.books||[];H.value=l,oe.value=r.count||l.length,M.value=!!(r.count&&r.count>l.length)}catch(e){V(e.message||"加载失败")}finally{J.value=!1}}function he(s){m.value=s,M.value&&b({keepPage:!0})}function ne(){Object.assign(o,{isbn:"",title:"",author:"",publisher:"",publish_date:"",category_id:null,total_copies:1,location:"",description:""}),x.value="",D()}function D(s=""){P.value=null,X.value&&(X.value.value=""),h&&(URL.revokeObjectURL(h),h=null),W.value=s}function ke(s){var l,u,O;const e=(l=s.target.files)==null?void 0:l[0];if(!e)return;if(e.type&&!e.type.startsWith("image/")){x.value="封面必须是图片文件",D(((u=c.value)==null?void 0:u.cover_url)||"");return}const r=5*1024*1024;if(e.size>r){x.value="封面大小不能超过 5MB",D(((O=c.value)==null?void 0:O.cover_url)||"");return}P.value=e,h&&URL.revokeObjectURL(h),h=URL.createObjectURL(e),W.value=h}function we(){var s;D(((s=c.value)==null?void 0:s.cover_url)||"")}function Ce(){c.value=null,U.value.length===0&&w(),ne(),S.value=!0}function Y(){S.value=!1,c.value=null,ne()}function Ve(){Object.assign(f,{name:"",description:""}),_.value=""}function Ue(){N.value=!0,w()}function Me(){N.value=!1}function ie(s=null){$.value=s,Object.assign(f,{name:(s==null?void 0:s.name)||"",description:(s==null?void 0:s.description)||""}),_.value="",E.value=!0}function ee(){E.value=!1,$.value=null,Ve()}async function Se(){_.value="",G.value=!0;try{const s={name:(f.name||"").trim(),description:(f.description||"").trim()};if(!s.name){_.value="分类名称不能为空";return}$.value?(await se(`/api/categories/${$.value.id}`,s),k("分类已更新")):(await me("/api/categories",s),k("分类已创建")),await w(),ee()}catch(s){_.value=s.message||"操作失败"}finally{G.value=!1}}function je(s){F.value=s,B.value=!0}async function Be(){if(F.value){T.value=!0;try{const s=F.value.id;await fe(`/api/categories/${s}`),k("分类已删除"),B.value=!1,F.value=null,o.category_id===s&&(o.category_id=null),await w()}catch(s){V(s.message||"删除失败")}finally{T.value=!1}}}function $e(s){var e;c.value=s,U.value.length===0&&w(),Object.assign(o,{isbn:s.isbn||"",title:s.title||"",author:s.author||"",publisher:s.publisher||"",publish_date:s.publish_date||"",category_id:((e=s.category)==null?void 0:e.id)??null,total_copies:s.total_copies||1,location:s.location||"",description:s.description||""}),D(s.cover_url||""),S.value=!0}async function Fe(){var s,e,r;x.value="",q.value=!0;try{const l={...o};l.publish_date||delete l.publish_date,!l.category_id&&l.category_id!==0&&(l.category_id=null);let u=(s=c.value)==null?void 0:s.id;const O=!!c.value;c.value?u=((e=(await se(`/api/books/${c.value.id}`,l)).book)==null?void 0:e.id)??u:u=(r=(await me("/api/books",l)).book)==null?void 0:r.id;let ue=!1;if(P.value&&u!=null)try{const C=new FormData;C.append("cover",P.value),await Ke(`/api/books/${u}/cover`,C)}catch(C){V(C.message||"封面上传失败"),ue=!0}ue?k(O?"更新成功（封面未更新）":"添加成功（封面未上传）"):k(O?"更新成功":"添加成功"),Y(),await b({keepPage:!0})}catch(l){x.value=l.message||"操作失败"}finally{q.value=!1}}async function Pe(s){try{const e=s.status==="on_shelf"?"off_shelf":"on_shelf";await se(`/api/books/${s.id}`,{status:e}),k(e==="on_shelf"?"已上架":"已下架"),await b({keepPage:!0})}catch(e){V(e.message||"操作失败")}}function De(s){A.value=s,j.value=!0}async function Oe(){K.value=!0;try{await fe(`/api/books/${A.value.id}`),k("删除成功"),j.value=!1,A.value=null,await b({keepPage:!0})}catch(s){V(s.message||"删除失败")}finally{K.value=!1}}return(s,e)=>{const r=ze("router-link");return y(),g("div",null,[t("div",We,[e[22]||(e[22]=t("h1",{class:"text-2xl font-semibold text-text-primary"},"图书管理",-1)),t("div",Ze,[t("button",{onClick:Ce,class:"btn-primary"}," + 新增图书 "),t("button",{onClick:Ue,class:"btn-secondary"}," 分类管理 "),v(r,{to:"/manage/import-export/",class:"btn-secondary"},{default:i(()=>[...e[21]||(e[21]=[L(" 导入/导出 ",-1)])]),_:1})])]),t("div",He,[t("div",Je,[d(t("input",{"onUpdate:modelValue":e[0]||(e[0]=l=>z.value=l),type:"text",placeholder:"搜索书名、作者、ISBN...",class:"w-full pl-12 pr-4 py-2.5 input",onKeyup:Ie(b,["enter"])},null,544),[[p,z.value]]),v(ce(Ge),{class:"absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-text-muted","stroke-width":2})]),d(t("select",{"onUpdate:modelValue":e[1]||(e[1]=l=>I.value=l),class:"input w-40",onChange:b},[...e[23]||(e[23]=[t("option",{value:""},"全部状态",-1),t("option",{value:"on_shelf"},"已上架",-1),t("option",{value:"off_shelf"},"已下架",-1)])],544),[[ve,I.value]]),t("button",{onClick:b,class:"btn-primary"},"搜索")]),v(be,{columns:ge,data:xe.value,loading:J.value,"row-key":"id"},{isbn:i(({value:l})=>[t("span",Qe,n(l),1)]),status:i(({row:l})=>[t("span",{class:Ne(["inline-flex items-center px-2.5 py-1 text-xs font-medium rounded-lg",l.status==="on_shelf"?"bg-emerald-50 text-emerald-600":"bg-border-light text-text-muted"])},n(l.status==="on_shelf"?"上架":"下架"),3)]),copies:i(({row:l})=>[t("span",Xe,n(l.available_copies),1),t("span",Ye," / "+n(l.total_copies),1)]),actions:i(({row:l})=>[t("div",et,[t("button",{onClick:u=>$e(l),class:"text-claude-600 hover:text-claude-700 text-sm font-medium"}," 编辑 ",8,tt),t("button",{onClick:u=>Pe(l),class:"text-amber-600 hover:text-amber-700 text-sm font-medium"},n(l.status==="on_shelf"?"下架":"上架"),9,lt),t("button",{onClick:u=>De(l),class:"text-red-500 hover:text-red-600 text-sm font-medium"}," 删除 ",8,st)])]),_:1},8,["data","loading"]),t("div",at,[v(Te,{"current-page":m.value,"total-pages":Z.value,onChange:he},null,8,["current-page","total-pages"])]),v(R,{modelValue:S.value,"onUpdate:modelValue":e[11]||(e[11]=l=>S.value=l),title:c.value?"编辑图书":"新增图书",size:"lg",onClose:Y},{default:i(()=>[t("form",{onSubmit:pe(Fe,["prevent"])},[t("div",ot,[t("div",null,[e[24]||(e[24]=t("label",{class:"label"},[L("ISBN "),t("span",{class:"text-red-500"},"*")],-1)),d(t("input",{"onUpdate:modelValue":e[2]||(e[2]=l=>o.isbn=l),type:"text",class:"input",required:""},null,512),[[p,o.isbn]])]),t("div",null,[e[25]||(e[25]=t("label",{class:"label"},[L("书名 "),t("span",{class:"text-red-500"},"*")],-1)),d(t("input",{"onUpdate:modelValue":e[3]||(e[3]=l=>o.title=l),type:"text",class:"input",required:""},null,512),[[p,o.title]])]),t("div",null,[e[26]||(e[26]=t("label",{class:"label"},[L("作者 "),t("span",{class:"text-red-500"},"*")],-1)),d(t("input",{"onUpdate:modelValue":e[4]||(e[4]=l=>o.author=l),type:"text",class:"input",required:""},null,512),[[p,o.author]])]),t("div",null,[e[27]||(e[27]=t("label",{class:"label"},"出版社",-1)),d(t("input",{"onUpdate:modelValue":e[5]||(e[5]=l=>o.publisher=l),type:"text",class:"input"},null,512),[[p,o.publisher]])]),t("div",null,[e[28]||(e[28]=t("label",{class:"label"},"出版日期",-1)),d(t("input",{"onUpdate:modelValue":e[6]||(e[6]=l=>o.publish_date=l),type:"date",class:"input"},null,512),[[p,o.publish_date]])]),t("div",null,[e[30]||(e[30]=t("label",{class:"label"},"分类",-1)),d(t("select",{"onUpdate:modelValue":e[7]||(e[7]=l=>o.category_id=l),class:"input"},[e[29]||(e[29]=t("option",{value:null},"无",-1)),(y(!0),g(Ee,null,Ae(_e.value,l=>(y(),g("option",{key:l.id,value:l.id},n(l.name),9,nt))),128))],512),[[ve,o.category_id]])]),t("div",null,[e[31]||(e[31]=t("label",{class:"label"},"总库存",-1)),d(t("input",{"onUpdate:modelValue":e[8]||(e[8]=l=>o.total_copies=l),type:"number",min:"0",class:"input"},null,512),[[p,o.total_copies,void 0,{number:!0}]])]),t("div",null,[e[32]||(e[32]=t("label",{class:"label"},"位置",-1)),d(t("input",{"onUpdate:modelValue":e[9]||(e[9]=l=>o.location=l),type:"text",class:"input",placeholder:"如 A-01"},null,512),[[p,o.location]])]),t("div",it,[e[34]||(e[34]=t("label",{class:"label"},"封面",-1)),t("div",ut,[t("div",dt,[W.value?(y(),g("img",{key:0,src:W.value,alt:"封面预览",class:"w-full h-full object-cover"},null,8,rt)):(y(),g("div",ct,[v(ce(qe),{class:"w-8 h-8","stroke-width":1})]))]),t("div",vt,[t("input",{ref_key:"coverInputRef",ref:X,type:"file",accept:"image/*",class:"input",onChange:ke},null,544),t("div",pt,[e[33]||(e[33]=t("p",{class:"text-xs text-text-muted whitespace-nowrap"},"支持图片，≤ 5MB",-1)),P.value?(y(),g("button",{key:0,type:"button",class:"text-xs text-text-muted hover:text-red-500 whitespace-nowrap",onClick:we}," 移除 ")):le("",!0)])])])]),t("div",mt,[e[35]||(e[35]=t("label",{class:"label"},"简介",-1)),d(t("textarea",{"onUpdate:modelValue":e[10]||(e[10]=l=>o.description=l),rows:"3",class:"input"},null,512),[[p,o.description]])])]),x.value?(y(),g("div",ft,n(x.value),1)):le("",!0),t("div",bt,[t("button",{type:"button",onClick:Y,class:"btn-secondary"},"取消"),t("button",{type:"submit",disabled:q.value,class:"btn-primary"},n(q.value?"保存中...":"保存"),9,gt)])],32)]),_:1},8,["modelValue","title"]),v(R,{modelValue:j.value,"onUpdate:modelValue":e[13]||(e[13]=l=>j.value=l),title:"确认删除",size:"sm"},{footer:i(()=>[t("button",{onClick:e[12]||(e[12]=l=>j.value=!1),class:"btn-secondary"},"取消"),t("button",{onClick:Oe,disabled:K.value,class:"btn-danger"},n(K.value?"删除中...":"确认删除"),9,xt)]),default:i(()=>{var l;return[t("p",yt,"确定要删除《"+n((l=A.value)==null?void 0:l.title)+"》吗？此操作不可恢复。",1)]}),_:1},8,["modelValue"]),v(R,{modelValue:N.value,"onUpdate:modelValue":e[15]||(e[15]=l=>N.value=l),title:"分类管理",size:"lg",onClose:Me},{default:i(()=>[t("div",_t,[e[36]||(e[36]=t("p",{class:"text-sm text-text-muted"},"新增/编辑/删除图书分类",-1)),t("button",{onClick:e[14]||(e[14]=l=>ie()),class:"btn-primary"}," + 新增分类 ")]),v(be,{columns:ye,data:U.value,loading:Q.value,"row-key":"id","empty-text":"暂无分类"},{description:i(({value:l})=>[t("span",ht,n(l||"-"),1)]),actions:i(({row:l})=>[t("div",kt,[t("button",{onClick:u=>ie(l),class:"text-claude-600 hover:text-claude-700 text-sm font-medium"}," 编辑 ",8,wt),t("button",{onClick:u=>je(l),class:"text-red-500 hover:text-red-600 text-sm font-medium"}," 删除 ",8,Ct)])]),_:1},8,["data","loading"])]),_:1},8,["modelValue"]),v(R,{modelValue:E.value,"onUpdate:modelValue":e[18]||(e[18]=l=>E.value=l),title:$.value?"编辑分类":"新增分类",size:"md",onClose:ee},{default:i(()=>[t("form",{onSubmit:pe(Se,["prevent"])},[t("div",Vt,[t("div",null,[e[37]||(e[37]=t("label",{class:"label"},[L("分类名称 "),t("span",{class:"text-red-500"},"*")],-1)),d(t("input",{"onUpdate:modelValue":e[16]||(e[16]=l=>f.name=l),type:"text",class:"input",required:""},null,512),[[p,f.name]])]),t("div",null,[e[38]||(e[38]=t("label",{class:"label"},"简介",-1)),d(t("textarea",{"onUpdate:modelValue":e[17]||(e[17]=l=>f.description=l),rows:"3",class:"input"},null,512),[[p,f.description]])])]),_.value?(y(),g("div",Ut,n(_.value),1)):le("",!0),t("div",Mt,[t("button",{type:"button",onClick:ee,class:"btn-secondary"},"取消"),t("button",{type:"submit",disabled:G.value,class:"btn-primary"},n(G.value?"保存中...":"保存"),9,St)])],32)]),_:1},8,["modelValue","title"]),v(R,{modelValue:B.value,"onUpdate:modelValue":e[20]||(e[20]=l=>B.value=l),title:"确认删除分类",size:"sm"},{footer:i(()=>[t("button",{onClick:e[19]||(e[19]=l=>B.value=!1),class:"btn-secondary"},"取消"),t("button",{onClick:Be,disabled:T.value,class:"btn-danger"},n(T.value?"删除中...":"确认删除"),9,Bt)]),default:i(()=>{var l;return[t("p",jt," 确定要删除分类「"+n((l=F.value)==null?void 0:l.name)+"」吗？删除后该分类下的图书将变为未分类。 ",1)]}),_:1},8,["modelValue"])])}}};export{Ot as default};
