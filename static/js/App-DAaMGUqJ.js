import{g as r,c as C,h as G,x as Q,i as Y,j as S,d as M,b as a,e as _,k as R,v as Z,l as q,u as H,M as J,w as u,Q as O,C as U,o as P,n as W,t as n,A as X}from"./index-BgujHqiP.js";import{_ as ee,M as te}from"./Modal-DX_OzK7H.js";import{S as ae,_ as se}from"./Pagination-BswjxdYU.js";const oe={class:"flex items-center gap-4 mb-6"},ne={class:"flex-1 relative"},le={class:"font-medium text-text-primary"},re={class:"text-xs text-text-muted"},ue={class:"font-medium text-text-primary"},ie={class:"text-xs text-text-muted font-mono"},ce={class:"font-mono text-xs bg-sidebar px-2 py-1 rounded"},de={class:"whitespace-nowrap"},pe={class:"whitespace-nowrap"},ve={class:"whitespace-nowrap"},fe=["onClick"],me={key:1,class:"text-text-light text-sm"},xe={class:"mt-8"},we={class:"text-text-secondary"},ge=["disabled"],V=20,ke={__name:"App",setup(_e){const A=[{key:"id",title:"ID",width:"60px"},{key:"user",title:"用户"},{key:"book",title:"图书"},{key:"copy",title:"副本",width:"90px"},{key:"borrow_date",title:"借阅日期",width:"110px"},{key:"due_date",title:"应还日期",width:"110px"},{key:"return_date",title:"归还日期",width:"110px"},{key:"status",title:"状态",width:"110px"},{key:"actions",title:"操作",width:"120px"}],x=r([]),c=r(!1),h=r(!0),v=r(""),f=r(""),i=r(1),$=r(0),m=r(!1),d=r(null),w=r(!1),y=C(()=>{if(c.value)return x.value;let t=x.value;f.value==="borrowed"&&(t=t.filter(e=>!e.return_date&&!e.is_overdue));const s=v.value.trim().toLowerCase();return s?t.filter(e=>{var B,D,F;const o=((B=e.user)==null?void 0:B.username)||"",l=((D=e.book)==null?void 0:D.title)||"",g=((F=e.book)==null?void 0:F.isbn)||"";return[o,l,g].some(T=>String(T).toLowerCase().includes(s))}):t}),b=C(()=>{const t=c.value?$.value:y.value.length;return Math.max(1,Math.ceil(t/V))}),E=C(()=>{if(c.value)return x.value;const t=(i.value-1)*V;return y.value.slice(t,t+V)});G(async()=>{await p()}),Q([c,y],()=>{c.value||(i.value>b.value&&(i.value=b.value),i.value<1&&(i.value=1))});async function p({keepPage:t=!1}={}){t||(i.value=1),h.value=!0;try{const s=new URLSearchParams;v.value&&s.set("kw",v.value),f.value&&s.set("status",f.value),s.set("page",i.value);const e=await Y("/api/borrows?"+s.toString()),o=e.results||e.borrows||[];x.value=o,$.value=e.count||o.length,c.value=!!(e.count&&e.count>o.length)}catch(s){S(s.message||"加载失败")}finally{h.value=!1}}function K(t){i.value=t,c.value&&p({keepPage:!0})}function k(t){if(!t)return"-";const s=new Date(t);return`${s.getFullYear()}-${String(s.getMonth()+1).padStart(2,"0")}-${String(s.getDate()).padStart(2,"0")}`}function L(t){return t.return_date?"已归还":t.is_overdue?"逾期":"借阅中"}function j(t){return t.return_date?"bg-border-light text-text-muted":t.is_overdue?"bg-red-50 text-red-600":"bg-claude-50 text-claude-600"}async function z(){try{await O("/api/admin/borrows/export","borrows.csv"),U("导出成功")}catch(t){S(t.message||"导出失败")}}function I(t){d.value=t,m.value=!0}async function N(){if(d.value){w.value=!0;try{await X(`/api/borrows/${d.value.id}/return`),U("已强制归还"),m.value=!1,d.value=null,await p({keepPage:!0})}catch(t){S(t.message||"归还失败")}finally{w.value=!1}}}return(t,s)=>(P(),M("div",null,[a("div",{class:"flex items-center justify-between mb-8"},[s[4]||(s[4]=a("h1",{class:"text-2xl font-semibold text-text-primary"},"借阅记录",-1)),a("button",{onClick:z,class:"btn-secondary"}," 导出 CSV ")]),a("div",oe,[a("div",ne,[R(a("input",{"onUpdate:modelValue":s[0]||(s[0]=e=>v.value=e),type:"text",placeholder:"搜索用户名、书名...",class:"w-full pl-12 pr-4 py-2.5 input",onKeyup:q(p,["enter"])},null,544),[[Z,v.value]]),_(H(ae),{class:"absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-text-muted","stroke-width":2})]),R(a("select",{"onUpdate:modelValue":s[1]||(s[1]=e=>f.value=e),class:"input w-40",onChange:p},[...s[5]||(s[5]=[a("option",{value:""},"全部状态",-1),a("option",{value:"borrowed"},"借阅中",-1),a("option",{value:"overdue"},"逾期",-1),a("option",{value:"returned"},"已归还",-1)])],544),[[J,f.value]]),a("button",{onClick:p,class:"btn-primary"},"搜索")]),_(ee,{columns:A,data:E.value,loading:h.value,"row-key":"id"},{user:u(({row:e})=>{var o,l;return[a("div",null,[a("div",le,n((o=e.user)==null?void 0:o.username),1),a("div",re,n(((l=e.user)==null?void 0:l.mail)||"-"),1)])]}),book:u(({row:e})=>{var o,l;return[a("div",null,[a("div",ue,n((o=e.book)==null?void 0:o.title),1),a("div",ie,n((l=e.book)==null?void 0:l.isbn),1)])]}),copy:u(({row:e})=>{var o;return[a("span",ce,n(((o=e.copy)==null?void 0:o.code)||"-"),1)]}),borrow_date:u(({value:e})=>[a("span",de,n(k(e)),1)]),due_date:u(({value:e})=>[a("span",pe,n(k(e)),1)]),return_date:u(({value:e})=>[a("span",ve,n(e?k(e):"-"),1)]),status:u(({row:e})=>[a("span",{class:W(["inline-flex items-center px-2 py-0.5 text-xs font-medium rounded-lg whitespace-nowrap",j(e)])},n(L(e)),3)]),actions:u(({row:e})=>[e.return_date?(P(),M("span",me,"-")):(P(),M("button",{key:0,onClick:o=>I(e),class:"btn-danger px-2.5 py-1 text-xs whitespace-nowrap"}," 强制归还 ",8,fe))]),_:1},8,["data","loading"]),a("div",xe,[_(se,{"current-page":i.value,"total-pages":b.value,onChange:K},null,8,["current-page","total-pages"])]),_(te,{modelValue:m.value,"onUpdate:modelValue":s[3]||(s[3]=e=>m.value=e),title:"确认强制归还",size:"sm"},{footer:u(()=>[a("button",{onClick:s[2]||(s[2]=e=>m.value=!1),class:"btn-secondary"},"取消"),a("button",{onClick:N,disabled:w.value,class:"btn-danger"},n(w.value?"归还中...":"确认归还"),9,ge)]),default:u(()=>{var e,o,l,g;return[a("p",we," 确认将《"+n((o=(e=d.value)==null?void 0:e.book)==null?void 0:o.title)+"》从 "+n((g=(l=d.value)==null?void 0:l.user)==null?void 0:g.username)+" 的借阅中强制归还吗？ ",1)]}),_:1},8,["modelValue"])]))}};export{ke as default};
